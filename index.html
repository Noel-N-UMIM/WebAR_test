<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MindAR - Always Visible Sticky Content</title>
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- MindAR Image Tracking -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      
      /* UI Overlay */
      #ui-overlay {
        position: absolute;
        bottom: 20px;
        left: 0;
        width: 100%;
        text-align: center;
        z-index: 10;
        pointer-events: none;
      }
      
      .status-pill {
        display: inline-block;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 20px;
        border-radius: 30px;
        font-size: 14px;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255,255,255,0.2);
      }

      .status-pill.active {
        background: rgba(46, 204, 113, 0.8);
        color: #fff;
        font-weight: bold;
        transform: scale(1.05);
      }

      .status-pill.lost {
        background: rgba(231, 76, 60, 0.8);
      }

      #start-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 20;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        font-size: 18px;
        border-radius: 50px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        pointer-events: auto;
      }
    </style>

    <script>
      /**
       * Component: sticky-content
       * * Decouples the content from the MindAR target. 
       * It manually copies the transform of the target to the content
       * only when the target is actively found.
       */
      AFRAME.registerComponent('sticky-content', {
        schema: {
          target: {type: 'selector'} // The MindAR target entity
        },

        init: function() {
          this.targetEl = this.data.target;
          this.isTracking = false;
          this.statusUI = document.getElementById('status-text');

          // Bind event listeners to the TARGET entity, not this entity
          this.targetEl.addEventListener('targetFound', () => {
            this.isTracking = true;
            this.updateUI("Target Found - Content Locked");
            
            // Optional: Add a pop animation when found
            this.el.setAttribute('animation', {
              property: 'scale',
              to: '0.1 0.1 0.1',
              dur: 300,
              easing: 'easeOutElastic'
            });
          });

          this.targetEl.addEventListener('targetLost', () => {
            this.isTracking = false;
            this.updateUI("Target Lost - Content Frozen in Place");
          });
        },

        updateUI: function(msg) {
          if(this.statusUI) {
            this.statusUI.innerText = msg;
            if(this.isTracking) {
              this.statusUI.classList.add('active');
              this.statusUI.classList.remove('lost');
            } else {
              this.statusUI.classList.remove('active');
              this.statusUI.classList.add('lost');
            }
          }
        },

        tick: function() {
          // The Magic: Only sync position if currently tracking
          if (this.isTracking && this.targetEl.object3D.visible) {
            // We copy the world position/rotation/scale from target to this entity
            this.el.object3D.position.copy(this.targetEl.object3D.position);
            this.el.object3D.quaternion.copy(this.targetEl.object3D.quaternion);
            
            // For scale, we might want to keep it consistent or sync it
            // this.el.object3D.scale.copy(this.targetEl.object3D.scale); 
          }
        }
      });
    </script>
  </head>
  <body>

    <!-- UI Overlay -->
    <div id="ui-overlay">
      <div id="status-text" class="status-pill">Scan the Raccoon Card</div>
    </div>

    <!-- Start Button (AR often needs user interaction to start audio/video) -->
    <button id="start-button">Start AR Experience</button>

    <!-- AR Scene 
         mindar-image: imageTargetSrc points to the standard example card. 
         missTolerance: 0 ensures lost event fires quickly for cleaner "sticking"
    -->
    <a-scene 
      mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind; autoStart: false; uiLoading: no; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.001;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">

      <!-- Assets -->
      <a-assets>
        <!-- Standard Raccoon Model -->
        <a-asset-item id="raccoonModel" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/band-example/raccoon/scene.gltf"></a-asset-item>
      </a-assets>

      <!-- Camera -->
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- 
        THE TARGET 
        This is an empty entity that purely tracks the image.
        Note: It has NO visible children.
      -->
      <a-entity id="my-target" mindar-image-target="targetIndex: 0"></a-entity>

      <!-- 
        THE CONTENT
        This is a SIBLING to the target (Decoupled).
        It uses the 'sticky-content' component to follow 'my-target'.
      -->
      <a-entity 
        id="my-content" 
        sticky-content="target: #my-target"
        visible="true">
        
        <!-- The actual 3D model inside our sticky container -->
        <a-gltf-model 
          rotation="0 0 0" 
          position="0 0 0.1" 
          scale="0.1 0.1 0.1" 
          src="#raccoonModel" 
          animation="property: position; to: 0 0.1 0.1; dir: alternate; dur: 2000; loop: true">
        </a-gltf-model>

        <!-- A little shadow plane to make it look grounded in air -->
        <a-plane 
            position="0 -0.05 0.1" 
            rotation="-90 0 0" 
            width="0.5" 
            height="0.5" 
            color="#000" 
            opacity="0.3"
            material="transparent: true">
        </a-plane>

      </a-entity>

      <!-- Lights -->
      <a-light type="ambient" intensity="0.6"></a-light>
      <a-light type="directional" position="1 1 1" intensity="0.8"></a-light>

    </a-scene>

    <script>
      const startBtn = document.getElementById('start-button');
      const scene = document.querySelector('a-scene');

      startBtn.addEventListener('click', () => {
        startBtn.style.display = 'none';
        scene.systems['mindar-image-system'].start();
        
        // Show scanning UI
        const ui = document.getElementById('status-text');
        ui.innerText = "Scanning...";
      });
    </script>
  </body>
</html>
