<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>MindAR Keep Visible</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <!-- 1. Libraries: A-Frame 1.4.2 + MindAR 1.2.5 -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      body { margin: 0; overflow: hidden; font-family: sans-serif; }
      
      /* UI Overlay for Scanning Instructions */
      #scanning-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10;
        pointer-events: none; /* click-through */
      }

      .message-box {
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        pointer-events: auto;
      }
      
      a { color: #4dc3ff; font-weight: bold; }
    </style>

    <script>
      /**
       * Component: stick-to-target
       * Logic:
       * 1. Check if the Image Target is currently being tracked.
       * 2. If YES: Copy its position/rotation to the content entity.
       * 3. If NO: Do nothing (Content stays visible at last known position).
       */
      AFRAME.registerComponent('stick-to-target', {
        schema: {
          target: {type: 'selector'},  // The MindAR Target
          content: {type: 'selector'}  // The Visual 3D Object
        },

        init: function() {
          this.isTracked = false;

          // Listen for MindAR events on the target
          this.data.target.addEventListener('targetFound', () => {
            console.log("Target Found");
            this.isTracked = true;
            
            // Optional: Hide the scanning UI once found
            const overlay = document.querySelector('#scanning-overlay');
            if(overlay) overlay.style.display = 'none';
          });

          this.data.target.addEventListener('targetLost', () => {
            console.log("Target Lost - Keeping content visible");
            this.isTracked = false;
            // We do NOT hide the content here.
          });
        },

        tick: function() {
          if (this.isTracked && this.data.target && this.data.content) {
            // Copy Transform from Target -> Content
            const target3D = this.data.target.object3D;
            const content3D = this.data.content.object3D;

            // In MindAR, the target moves relative to the camera. 
            // We just match that world matrix.
            content3D.position.copy(target3D.position);
            content3D.quaternion.copy(target3D.quaternion);
            content3D.scale.copy(target3D.scale);
            
            // Ensure it's visible (in case it started hidden)
            content3D.visible = true;
          }
        }
      });
    </script>
  </head>

  <body>
    
    <div id="scanning-overlay">
      <div class="message-box">
        <p>ðŸ“¡ Point camera at the <b>Raccoon Image</b></p>
        <p><a href="https://hiukim.github.io/mind-ar-js-doc/assets/images/raccoon-2ef571baece2ee4724d0d19edf3de791.png" target="_blank">Open Target Image</a></p>
      </div>
    </div>

    <!-- 
      MindAR Scene Config
      uiLoading: no; uiScanning: no -> We handle UI manually
    -->
    <a-scene 
      mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/band/band.mind; maxTrack: 1; uiLoading: no; uiScanning: no;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">

      <a-assets>
        <img id="boxTexture" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/cubes.jpg">
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- 
        1. THE TRACKER (Invisible)
        This entity is controlled by MindAR. It moves when the image is found.
        It is invisible or has no geometry itself.
      -->
      <a-entity id="my-target" mindar-image-target="targetIndex: 0"></a-entity>

      <!-- 
        2. THE CONTENT (Visible)
        This sits in the scene root.
        The 'stick-to-target' component moves this to match #my-target.
      -->
      <a-entity 
        id="my-content" 
        stick-to-target="target: #my-target; content: #my-content"
        visible="false">
        
        <!-- A simple Box Model -->
        <a-box 
          position="0 0 0.1" 
          scale="0.5 0.5 0.5" 
          material="src: #boxTexture; color: #4CC3D9"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 5000; easing: linear">
        </a-box>

      </a-entity>

    </a-scene>
  </body>
</html>
