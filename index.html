<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MindAR Interactive Game</title>
    
    <!-- 1. Load A-Frame 1.4.2 -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    
    <!-- 2. Load MindAR 1.2.5 -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      body { margin: 0; overflow: hidden; }
      
      /* UI Overlay for the Game */
      #ui-layer {
        position: absolute;
        bottom: 20px;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none; /* Let clicks pass through to 3D scene */
        z-index: 999;
        display: flex; /* Visible by default so user sees "Scan" message */
        flex-direction: column;
        justify-content: flex-end;
        align-items: center;
      }
      
      /* The Jump Button */
      #jump-btn {
        pointer-events: auto; /* Enable clicking */
        background: linear-gradient(135deg, #2196F3, #21CBF3);
        color: white;
        border: 4px solid white;
        padding: 20px 80px; /* Wider button */
        font-size: 28px;
        font-weight: 800;
        border-radius: 50px;
        font-family: sans-serif;
        text-transform: uppercase;
        box-shadow: 0px 5px 15px rgba(0,0,0,0.5);
        margin-bottom: 50px;
        transition: transform 0.1s;
        cursor: pointer;
        display: none; /* Hidden until target found */
      }

      #jump-btn:active {
        transform: scale(0.95);
        background: #1976D2;
      }
      
      /* Status Message */
      #status-msg {
        pointer-events: auto;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        margin-bottom: 20px;
        font-family: sans-serif;
        font-weight: bold;
        font-size: 18px;
        text-align: center;
      }
    </style>

    <script>
      // --- COMPONENT 1: SMOOTH TRACKING ---
      AFRAME.registerComponent('follow-target', {
        schema: {
          target: { type: 'selector' },
          isTracking: { type: 'boolean', default: false },
          smoothFactor: { type: 'number', default: 0.1 }
        },
        init: function() {
          this.targetPos = new THREE.Vector3();
          this.targetQuat = new THREE.Quaternion();
          this.targetScale = new THREE.Vector3();
        },
        tick: function (time, timeDelta) {
          if (!this.data.isTracking) return;
          const targetEl = this.data.target;
          if (!targetEl || !targetEl.object3D.visible) return;

          const elObj = this.el.object3D;
          const targetObj = targetEl.object3D;
          targetObj.getWorldPosition(this.targetPos);
          targetObj.getWorldQuaternion(this.targetQuat);
          targetObj.getWorldScale(this.targetScale);

          const dist = elObj.position.distanceTo(this.targetPos);
          if (dist > 2) {
             elObj.position.copy(this.targetPos);
             elObj.quaternion.copy(this.targetQuat);
             elObj.scale.copy(this.targetScale);
          } else {
             const factor = this.data.smoothFactor;
             elObj.position.lerp(this.targetPos, factor);
             elObj.quaternion.slerp(this.targetQuat, factor);
             elObj.scale.lerp(this.targetScale, factor);
          }
        },
        startTracking: function () {
          this.data.isTracking = true;
          this.el.setAttribute('visible', 'true');
        },
        stopTracking: function () {
          this.data.isTracking = false;
        }
      });

      // --- COMPONENT 2: PLAYER PHYSICS (JUMP) ---
      AFRAME.registerComponent('player-jump', {
        schema: {
          isJumping: { type: 'boolean', default: false },
          groundY: { type: 'number', default: 0 },
          jumpPower: { type: 'number', default: 0.04 }, // CONTROL JUMP HEIGHT HERE
          gravity: { type: 'number', default: -0.002 }   // CONTROL FALL SPEED HERE
        },

        init: function() {
          this.velocity = 0;
          this.isDead = false;
          
          // Bind Jump Button
          const btn = document.querySelector('#jump-btn');
          if (btn) {
            const jumpAction = (e) => {
              e.preventDefault(); 
              e.stopPropagation();
              this.triggerJump();
            };
            btn.addEventListener('click', jumpAction);
            btn.addEventListener('touchstart', jumpAction);
          }
        },

        triggerJump: function() {
          if (this.data.isJumping || this.isDead) return;
          
          this.data.isJumping = true;
          this.velocity = this.data.jumpPower;
          
          // Visual flair: Rotate slightly when jumping
          this.el.setAttribute('rotation', '0 0 15');
        },

        setDead: function() {
          if(this.isDead) return;
          this.isDead = true;
          // Turn black and tip over
          this.el.setAttribute('material', 'color: black');
          this.el.setAttribute('rotation', '0 0 90');
        },

        tick: function(time, timeDelta) {
          if (!this.data.isJumping) return;

          // Physics Loop
          const el = this.el;
          let currentY = el.object3D.position.y;
          
          // Apply gravity
          // normalize to 60fps (timeDelta usually ~16ms)
          const deltaFrame = timeDelta / 16; 
          
          currentY += this.velocity * deltaFrame;
          this.velocity += this.data.gravity * deltaFrame;

          // Floor Hit Check
          if (currentY <= this.data.groundY) {
            currentY = this.data.groundY;
            this.data.isJumping = false;
            this.velocity = 0;
            // Reset rotation
            this.el.setAttribute('rotation', '0 0 0');
          }

          el.object3D.position.y = currentY;
        }
      });

      // --- COMPONENT 3: GAME MANAGER (OBSTACLES) ---
      AFRAME.registerComponent('game-manager', {
        schema: {
           speed: { type: 'number', default: 0.02 } // Control obstacle speed
        },
        init: function() {
          this.timer = 0;
          this.spawnRate = 1500; // Start faster (1.5s)
          this.obstacles = [];
          this.isPlaying = true;
          this.playerEl = null;
          this.msgEl = document.querySelector('#status-msg');
          
          console.log("Game Manager Initialized");
        },

        tick: function(time, timeDelta) {
          if (!this.isPlaying) return;
          
          // REMOVED VISIBILITY CHECK
          // Game loop runs even if target is lost, ensuring obstacles spawn in background

          // Find player safely
          if (!this.playerEl) {
            this.playerEl = document.querySelector('#player-model');
            return;
          }

          this.timer += timeDelta;

          // Spawn
          if (this.timer > this.spawnRate) {
            this.spawnObstacle();
            this.timer = 0;
            if (this.spawnRate > 1000) this.spawnRate -= 50; 
          }

          // Move & Collide
          const playerPos = this.playerEl.object3D.position;
          
          for (let i = 0; i < this.obstacles.length; i++) {
            const obs = this.obstacles[i];
            
            // Move Left
            obs.object3D.position.x -= this.data.speed * (timeDelta / 16);
            
            // Spin Obstacles (Visual Flair)
            obs.object3D.rotation.x += 0.02;
            obs.object3D.rotation.y += 0.03;

            // Collision Detection
            // Using a larger threshold now that the player box is bigger
            const distX = Math.abs(obs.object3D.position.x - playerPos.x);
            const distY = Math.abs(obs.object3D.position.y - playerPos.y);

            // Hitbox: Player width (0.25) + Obstacle width (0.15) approx / 2
            // Threshold 0.2 works well for these sizes
            if (distX < 0.2 && distY < 0.2) {
              this.gameOver();
            }

            // Cleanup
            if (obs.object3D.position.x < -1.5) {
              if (obs.parentNode) obs.parentNode.removeChild(obs);
              this.obstacles.splice(i, 1);
              i--;
            }
          }
        },

        spawnObstacle: function() {
          // console.log("Spawning Red Cube Obstacle");
          
          // Create entity
          const el = document.createElement('a-entity');
          
          // Define as a Red Box (Cube)
          el.setAttribute('geometry', {
            primitive: 'box',
            width: 0.25,
            height: 0.25,
            depth: 0.25
          });
          el.setAttribute('material', 'color: red'); // Bright Red
          
          // Start position
          el.setAttribute('position', '1.0 0 0'); 
          
          this.el.appendChild(el);
          this.obstacles.push(el);
        },

        gameOver: function() {
          console.log("Game Over");
          this.isPlaying = false;
          if (this.msgEl) {
            this.msgEl.style.display = 'block';
            this.msgEl.innerHTML = "GAME OVER! <br> Reload page to play again.";
          }
          if (this.playerEl && this.playerEl.components['player-jump']) {
            this.playerEl.components['player-jump'].setDead();
          }
        }
      });

      // --- SYSTEM: UI CONTROL ---
      document.addEventListener("DOMContentLoaded", function() {
        const exampleTarget = document.querySelector('#example-target');
        const content = document.querySelector('#persistent-content');
        const uiLayer = document.querySelector('#ui-layer');
        const jumpBtn = document.querySelector('#jump-btn');
        const statusMsg = document.querySelector('#status-msg');

        if(exampleTarget && content) {
          
          exampleTarget.addEventListener("targetFound", event => {
            console.log("Target Found - Game Resuming");
            content.components['follow-target'].startTracking();
            
            // UPDATE UI for Game State
            if(jumpBtn) jumpBtn.style.display = 'block';
            if(statusMsg) statusMsg.innerHTML = "Dodge the Red Cubes!";
          });

          exampleTarget.addEventListener("targetLost", event => {
            console.log("Target Lost - Game Paused");
            content.components['follow-target'].stopTracking();
            
            // UPDATE UI for Scan State
            if(jumpBtn) jumpBtn.style.display = 'none';
            if(statusMsg) statusMsg.innerHTML = "Target Lost. Scan Image to Resume.";
          });
        }
      });
    </script>
  </head>
  <body>
    <!-- 2D UI Layer -->
    <div id="ui-layer">
      <div id="status-msg">Scan Image to Play</div>
      <div id="jump-btn">JUMP</div>
    </div>

    <!-- 3D Scene -->
    <a-scene 
      mindar-image="imageTargetSrc: targets.mind; uiScanning: no; missTolerance: 5; warmupTolerance: 5;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <img id="card" src="card_MindAR.png" />
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- Lighting -->
      <a-light type="ambient" intensity="1"></a-light>
      <a-light type="directional" position="1 2 1" intensity="1.5"></a-light>

      <!-- Target -->
      <a-entity id="example-target" mindar-image-target="targetIndex: 0"></a-entity>
      
      <!-- Content Container -->
      <a-entity 
        id="persistent-content" 
        visible="false" 
        follow-target="target: #example-target"
        game-manager="speed: 0.02">
        
        <!-- Floor reference -->
        <a-plane color="#FFF" rotation="-90 0 0" width="10" height="2" position="0 -0.126 0" opacity="0.1" transparent="true"></a-plane>

        <!-- PLAYER (The Blue Box) -->
        <!-- 
             position: y=0.05 to sit on floor
             depth/height/width: 0.25 (Controls size)
             jumpPower: 0.04 (Controls jump height)
             gravity: -0.002 (Controls fall speed)
        -->
        <a-box 
          id="player-model"
          color="#52F27A"
          depth="0.25" 
          height="0.25" 
          width="0.25"
          position="-0.3 0.0 0" 
          player-jump="jumpPower: 0.04; gravity: -0.002"
        ></a-box> 
        
      </a-entity>

    </a-scene>
  </body>
</html>
