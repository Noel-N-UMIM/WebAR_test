<!DOCTYPE html>
<html>
  <head>
    <!-- Sets the viewport for mobile devices to ensure correct scaling -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <!-- Import A-Frame library 1.4.2 -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    
    <!-- Import MindAR library (engine for image tracking) -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      /* Basic reset for body margins */
      body { margin: 0; }
      
      /* Container for the "Start AR" button overlay */
      #start-button-container {
        position: absolute; /* Floating above content */
        top: 0; left: 0; right: 0; bottom: 0; /* Full screen */
        z-index: 11; /* Ensures it sits on top of the camera */
        display: flex; /* Use flexbox for centering */
        justify-content: center; /* Center horizontally */
        align-items: center; /* Center vertically */
        background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent black background */
        transition: opacity 0.5s ease;
      }
      
      /* Styling for the action button */
      .action-button {
        padding: 12px 24px;
        font-size: 1.2rem;
        font-weight: bold;
        color: white;
        background-color: #007aff; /* iOS Blue */
        border: none;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); /* Subtle shadow */
        transition: background-color 0.3s, transform 0.1s;
      }

      .action-button:active {
        transform: scale(0.98);
      }

      /* Disabled state for the button */
      .action-button:disabled {
        background-color: #555;
        opacity: 0.7;
        cursor: not-allowed;
      }
    </style>

    <script>
      // --- CUSTOM COMPONENT: The "Magnet" Logic ---
      
      AFRAME.registerComponent('follow-target', {
        schema: {
          target: {type: 'selector'}, 
          isTracking: {type: 'boolean', default: false},
          // Two speeds: one for normal tracking, one for the "long flight" catch-up
          trackFactor: {type: 'number', default: 0.1},   // Responsive (for jitter smoothing)
          catchUpFactor: {type: 'number', default: 0.02} // Slow & smooth (for re-acquisition fly-in)
        },
        
        init: function() {
          this.targetPos = new THREE.Vector3();
          this.targetQuat = new THREE.Quaternion();
          this.targetScale = new THREE.Vector3();
        },

        tick: function (time, timeDelta) {
          if (!this.data.isTracking || !this.data.target) return;
          
          if (!this.data.target.object3D.visible) {
            this.data.isTracking = false; 
            return;
          }

          const targetObj = this.data.target.object3D;
          const elObj = this.el.object3D;

          // 1. Calculate destination
          targetObj.getWorldPosition(this.targetPos);
          targetObj.getWorldQuaternion(this.targetQuat);
          targetObj.getWorldScale(this.targetScale);
          
          // 2. Determine Distance for Dynamic Smoothing
          // Calculate distance between current content position and target position
          const dist = elObj.position.distanceTo(this.targetPos);

          // 3. Select Factor
          // If distance is large (> 0.5 meters), use the slow 'catchUpFactor' to glide gently.
          // If distance is small (normal tracking), use 'trackFactor' to stay responsive.
          let t = this.data.trackFactor;
          if (dist > 0.5) {
             t = this.data.catchUpFactor;
          }

          // 4. Interpolate
          elObj.position.lerp(this.targetPos, t);
          elObj.quaternion.slerp(this.targetQuat, t);
          elObj.scale.lerp(this.targetScale, t);
        },
        
        startTracking: function() {
          this.data.isTracking = true;
        },
        stopTracking: function() {
          this.data.isTracking = false;
        }
      });

      document.addEventListener("DOMContentLoaded", function() {
        const sceneEl = document.querySelector('a-scene');
        const startButtonContainer = document.querySelector("#start-button-container");
        const startButton = document.querySelector("#start-button");
      
        const exampleTarget = document.querySelector('#example-target'); 
        const persistentContent = document.querySelector("#persistent-content");
        const videoAsset = document.querySelector("#videoAsset");
        
        let arSystem;

        const onSceneLoaded = () => {
          console.log("Scene loaded - AR System ready");
          arSystem = sceneEl.systems["mindar-image-system"];
          startButton.innerText = "Start AR";
          startButton.disabled = false;
        };

        if (sceneEl.hasLoaded) {
          onSceneLoaded();
        } else {
          sceneEl.addEventListener('loaded', onSceneLoaded);
        }

        if (videoAsset) {
          videoAsset.addEventListener('error', (e) => {
            console.error("Video Asset Error:", videoAsset.error);
          });
        }

        startButton.addEventListener('click', () => {
          if (!arSystem) return;
          
          // Prime video
          if (videoAsset) {
            videoAsset.play().then(() => {
              videoAsset.pause();
            }).catch(e => console.log("Video autoplay prevented:", e));
          }
          
          arSystem.start(); 
          startButtonContainer.style.display = 'none'; 
        });
        
        // EVENT: When the Image Target is detected 
        exampleTarget.addEventListener("targetFound", event => {
          console.log("target found");
          
          // --- NEW: Hide the scanning UI permanently after first find ---
          const scanningOverlay = document.querySelector('.mindar-ui-scanning');
          if (scanningOverlay) {
            scanningOverlay.style.display = 'none';
          }
          
          // Make the 3D content visible 
          persistentContent.setAttribute('visible', 'true');
          
          if (videoAsset) videoAsset.play(); 
          persistentContent.components['follow-target'].startTracking();
        });

        // EVENT: When the Image Target is lost 
        exampleTarget.addEventListener("targetLost", event => {
          console.log("target lost");
          persistentContent.components['follow-target'].stopTracking();
        });
      });
    </script>
  </head>
  
  <body>
    <!-- UI Overlay for Start Button -->
    <div id="start-button-container" class="button-container">
      <button id="start-button" class="action-button" disabled>Loading...</button>
    </div>
    
    <!-- AR Scene Setup -->
    <a-scene 
      mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind; autoStart: false; maxTrack: 2; filterMinCF:1; filterBeta:10000; warmupTolerance:0.5; missTolerance:0.5;"
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <video id="videoAsset" 
               preload="auto" 
               loop="true" 
               muted="true"
               playsinline 
               webkit-playsinline
               crossOrigin="anonymous" 
               src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/portfolio/portfolio.mp4">
        </video>
        <a-asset-item id="tigerModel" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/softmind/scene.gltf" preload="auto"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity id="example-target" mindar-image-target="targetIndex: 0"></a-entity>
      
      <!-- 
           Adjust 'trackFactor' (0.1) for jitter smoothing speed.
           Adjust 'catchUpFactor' (0.02) for the re-found "fly over" speed.
      -->
      <a-entity 
        id="persistent-content" 
        visible="false" 
        follow-target="target: #example-target; isTracking: false; trackFactor: 0.1; catchUpFactor: 0.05"
        >
        
        <a-video 
          id="ar-video"
          src="#videoAsset" 
          width="1" 
          height="0.552" 
          position="0 0 0" 
          rotation="0 0 0">
        </a-video>
        
        <a-gltf-model
          id="ar-model"
          src="#tigerModel"
          scale="0.005 0.005 0.005"
          position="0 0 0.1"
          rotation="0 0 0"
          animation="property: position; to: 0 0.1 0.1; dur: 1000; easing: easeInOutQuad; loop: true; dir: alternate">
        </a-gltf-model>

      </a-entity>
      
    </a-scene>
  </body>
</html>
