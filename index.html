<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MindAR Game: Dodge the Spheres</title>
    
    <!-- Libraries -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
      
      /* Main UI Layer */
      #ui-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 999;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        align-items: center;
        padding-bottom: 30px;
      }

      /* Buttons */
      .game-btn {
        pointer-events: auto;
        border: 3px solid white;
        color: white;
        font-weight: 800;
        text-transform: uppercase;
        border-radius: 50px;
        cursor: pointer;
        box-shadow: 0px 4px 10px rgba(0,0,0,0.5);
        transition: transform 0.1s, background 0.2s;
        display: none; /* Hidden by default */
        text-align: center;
        user-select: none;
      }

      .game-btn:active {
        transform: scale(0.95);
      }

      #start-btn {
        background: #4CAF50; /* Green */
        padding: 15px 40px;
        font-size: 24px;
        margin-bottom: 80px; /* Positioned higher than jump button */
      }

      #jump-btn {
        background: #2196F3; /* Blue */
        padding: 25px 80px; /* Big touch target */
        font-size: 28px;
        margin-bottom: 20px;
      }

      #restart-btn {
        background: #f44336; /* Red */
        padding: 15px 40px;
        font-size: 24px;
        margin-bottom: 80px;
      }

      /* Instructions / Status */
      #status-msg {
        position: absolute;
        top: 40%;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 20px 30px;
        border-radius: 20px;
        font-size: 20px;
        text-align: center;
        pointer-events: none;
        display: block;
      }
    </style>

    <script>
      /**
       * COMPONENT: PLAYER CONTROLLER
       * Handles physics (gravity, jumping) and collision state.
       */
      AFRAME.registerComponent('player-controller', {
        schema: {
          jumpForce: { type: 'number', default: 0.05 },
          gravity: { type: 'number', default: -0.0025 },
          groundY: { type: 'number', default: 0 }
        },
        init: function() {
          this.velocity = 0;
          this.isJumping = false;
          this.isDead = false;
        },
        jump: function() {
          if (this.isJumping || this.isDead) return;
          this.velocity = this.data.jumpForce;
          this.isJumping = true;
          // Visual: slight tilt
          this.el.setAttribute('rotation', '0 0 15');
        },
        reset: function() {
          this.isDead = false;
          this.isJumping = false;
          this.velocity = 0;
          this.el.object3D.position.y = this.data.groundY;
          this.el.setAttribute('rotation', '0 0 0');
          this.el.setAttribute('material', 'color', '#52F27A'); // Reset color to Blue
        },
        die: function() {
          this.isDead = true;
          this.el.setAttribute('material', 'color', '#555'); // Grey/Black death color
          this.el.setAttribute('rotation', '0 0 90'); // Tip over
        },
        tick: function(time, timeDelta) {
          if (this.isDead) return;

          // Only apply physics if jumping or above ground
          if (this.isJumping || this.el.object3D.position.y > this.data.groundY) {
            const dt = timeDelta / 16; // Normalize to ~60fps
            this.velocity += this.data.gravity * dt;
            
            let newY = this.el.object3D.position.y + (this.velocity * dt);

            // Hit Floor
            if (newY <= this.data.groundY) {
              newY = this.data.groundY;
              this.velocity = 0;
              this.isJumping = false;
              this.el.setAttribute('rotation', '0 0 0');
            }
            
            this.el.object3D.position.y = newY;
          }
        }
      });

      /**
       * COMPONENT: GAME MANAGER
       * Handles game state, UI toggling, and obstacle spawning loop.
       */
      AFRAME.registerComponent('game-manager', {
        init: function() {
          // DOM Elements
          this.uiStart = document.getElementById('start-btn');
          this.uiJump = document.getElementById('jump-btn');
          this.uiRestart = document.getElementById('restart-btn');
          this.statusMsg = document.getElementById('status-msg');
          this.player = document.getElementById('player');
          this.gameContainer = document.getElementById('game-container');
          
          // Game Variables
          this.isPlaying = false;
          this.isGameOver = false;
          this.obstacles = [];
          this.timer = 0;
          this.spawnInterval = 2000;
          this.gameSpeed = 0.03;

          // Initial UI State: Hide everything except instructions
          this.uiStart.style.display = 'none';
          this.uiJump.style.display = 'none';
          this.uiRestart.style.display = 'none';
          this.statusMsg.innerText = "Scan Target to Play";

          // Bind UI events
          this.uiStart.addEventListener('click', () => this.startGame());
          this.uiRestart.addEventListener('click', () => this.startGame());
          
          // Jump Event (Mouse & Touch)
          const handleJump = (e) => {
            e.preventDefault(); 
            if (this.isPlaying && !this.isGameOver) {
              this.player.components['player-controller'].jump();
            }
          };
          this.uiJump.addEventListener('mousedown', handleJump);
          this.uiJump.addEventListener('touchstart', handleJump);

          // MindAR Events for "Ready" state
          const target = document.getElementById('image-target');
          
          target.addEventListener('targetFound', () => {
            console.log("Target Found");
            
            // Show AR Content immediately
            this.gameContainer.setAttribute('visible', 'true');

            // If we are NOT playing and NOT in game over state, show Start button
            if (!this.isPlaying && !this.isGameOver) {
              this.statusMsg.style.display = 'none'; // Hide instructions
              this.uiStart.style.display = 'block'; // Show Start
            }
          });

          target.addEventListener('targetLost', () => {
            console.log("Target Lost");
            // Show scanning instructions again
            this.statusMsg.style.display = 'block';
            this.statusMsg.innerText = "Target Lost. Scan Image.";
            
            // Hide all game buttons to avoid confusion
            this.uiStart.style.display = 'none';
            this.uiJump.style.display = 'none';
            this.uiRestart.style.display = 'none';
            
            // Pause the game loop effectively
            this.isPlaying = false; 
          });
        },

        startGame: function() {
          console.log("Game Started");
          this.isPlaying = true;
          this.isGameOver = false;
          this.obstacles = [];
          this.timer = 0;
          this.spawnInterval = 2000;
          this.gameSpeed = 0.03;

          // Reset Player
          this.player.components['player-controller'].reset();

          // Clear old obstacles
          const oldObs = document.querySelectorAll('.obstacle');
          oldObs.forEach(el => {
            if (el.parentNode) el.parentNode.removeChild(el);
          });

          // Update UI: Hide Start/Restart, Show Jump
          this.uiStart.style.display = 'none';
          this.uiRestart.style.display = 'none';
          this.statusMsg.style.display = 'none'; // Ensure text is gone
          this.uiJump.style.display = 'block';
        },

        gameOver: function() {
          console.log("Game Over");
          this.isPlaying = false;
          this.isGameOver = true;
          this.player.components['player-controller'].die();
          
          // Update UI: Hide Jump, Show Restart
          this.uiJump.style.display = 'none';
          this.uiRestart.style.display = 'block';
          this.statusMsg.style.display = 'block';
          this.statusMsg.innerText = "GAME OVER";
        },

        spawnObstacle: function() {
          // Use a-entity with explicit geometry/material
          const el = document.createElement('a-entity');
          el.setAttribute('class', 'obstacle');
          
          // Geometry: Sphere
          el.setAttribute('geometry', 'primitive: sphere; radius: 0.15');
          
          // Material: Flat Shader (Self-illuminated) so it's always visible
          el.setAttribute('material', 'color: #FF0000; shader: flat');
          
          // Position: Start off to the right
          el.setAttribute('position', '1.5 0.15 0'); 
          
          this.gameContainer.appendChild(el);
          this.obstacles.push(el);
        },

        tick: function(time, timeDelta) {
          // CRITICAL: Stop everything if not playing
          if (!this.isPlaying) return;

          // 1. Spawning Logic
          this.timer += timeDelta;
          if (this.timer > this.spawnInterval) {
            this.spawnObstacle();
            this.timer = 0;
            // Gradually speed up
            if (this.spawnInterval > 800) this.spawnInterval -= 50;
          }

          // 2. Move Obstacles & Check Collision
          const playerPos = this.player.object3D.position;
          
          for (let i = 0; i < this.obstacles.length; i++) {
            const obs = this.obstacles[i];

            // Safety Check
            if (!obs.object3D) continue;

            // Move Left
            obs.object3D.position.x -= this.gameSpeed * (timeDelta / 16);

            // Check Collision (Distance between centers)
            const dx = obs.object3D.position.x - playerPos.x;
            const dy = obs.object3D.position.y - playerPos.y;
            const distance = Math.sqrt(dx*dx + dy*dy);

            // Radius (0.15) + Player Half-Size (approx 0.125) = ~0.275 threshold
            if (distance < 0.25) { 
              this.gameOver();
              return; // Stop processing this frame
            }

            // Despawn
            if (obs.object3D.position.x < -1.5) {
              obs.parentNode.removeChild(obs);
              this.obstacles.splice(i, 1);
              i--;
            }
          }
        }
      });
    </script>
  </head>
  <body>

    <!-- 2D UI Overlay -->
    <div id="ui-layer">
      <div id="status-msg">Scan Target to Play</div>
      <div id="start-btn" class="game-btn">START GAME</div>
      <div id="restart-btn" class="game-btn">TRY AGAIN</div>
      <div id="jump-btn" class="game-btn">JUMP</div>
    </div>

    <!-- AR Scene -->
    <a-scene 
      mindar-image="imageTargetSrc: targets.mind; uiScanning: no;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">

      <a-assets>
        <!-- Assets here -->
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- Light -->
      <a-light type="ambient" intensity="1"></a-light>
      <a-light type="directional" position="1 2 1" intensity="1.5"></a-light>

      <!-- Target Anchor -->
      <a-entity id="image-target" mindar-image-target="targetIndex: 0">
        
        <!-- Game Container (Attached to Image Target) -->
        <a-entity id="game-container" visible="false" game-manager>
          
          <!-- Floor Plane -->
          <a-plane 
            color="#FFFFFF" 
            opacity="0.3" 
            width="4" 
            height="2" 
            rotation="-90 0 0" 
            position="0 0 0">
          </a-plane>

          <!-- Player (Blue Box) -->
          <a-box 
            id="player" 
            color="#52F27A" 
            width="0.25" 
            height="0.25" 
            depth="0.25" 
            position="-0.3 0.125 0"
            player-controller="groundY: 0.125">
          </a-box>

        </a-entity>
      </a-entity>
    </a-scene>
  </body>
</html>
