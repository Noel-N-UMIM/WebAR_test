<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MindAR Interactive Game</title>
    
    <!-- 1. Load A-Frame 1.4.2 -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    
    <!-- 2. Load MindAR 1.2.5 -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <!-- 3. Load A-Frame Extras 7.2.0 (For Animation) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>

    <style>
      body { margin: 0; overflow: hidden; }
      
      /* UI Overlay for the Game */
      #ui-layer {
        position: absolute;
        bottom: 20px;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none; /* Let clicks pass through to 3D scene except on buttons */
        z-index: 999;
        display: none; /* Hidden until AR target is found */
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        align-items: center;
      }
      
      /* The Jump Button */
      #jump-btn {
        pointer-events: auto; /* Enable clicking on the button */
        background: linear-gradient(135deg, #ff4081, #d81b60);
        color: white;
        border: 4px solid white;
        padding: 20px 60px;
        font-size: 24px;
        font-weight: 800;
        border-radius: 50px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        text-transform: uppercase;
        box-shadow: 0px 5px 15px rgba(0,0,0,0.5);
        margin-bottom: 40px;
        transition: transform 0.1s;
        cursor: pointer;
        display: none; /* Hidden until model loads */
      }

      #jump-btn:active {
        transform: scale(0.95);
        background: #c2185b;
      }
      
      /* Status Message (Loading / Game Over) */
      #status-msg {
        pointer-events: auto;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        margin-bottom: 20px;
        font-family: sans-serif;
        font-weight: bold;
        font-size: 16px;
        text-align: center;
        display: block;
      }
    </style>

    <script>
      // --- COMPONENT 1: SMOOTH TRACKING ---
      AFRAME.registerComponent('follow-target', {
        schema: {
          target: { type: 'selector' },
          isTracking: { type: 'boolean', default: false },
          smoothFactor: { type: 'number', default: 0.1 }
        },
        init: function() {
          this.targetPos = new THREE.Vector3();
          this.targetQuat = new THREE.Quaternion();
          this.targetScale = new THREE.Vector3();
        },
        tick: function (time, timeDelta) {
          if (!this.data.isTracking) return;
          const targetEl = this.data.target;
          if (!targetEl || !targetEl.object3D.visible) return;

          const elObj = this.el.object3D;
          const targetObj = targetEl.object3D;
          targetObj.getWorldPosition(this.targetPos);
          targetObj.getWorldQuaternion(this.targetQuat);
          targetObj.getWorldScale(this.targetScale);

          const dist = elObj.position.distanceTo(this.targetPos);
          if (dist > 2) {
             elObj.position.copy(this.targetPos);
             elObj.quaternion.copy(this.targetQuat);
             elObj.scale.copy(this.targetScale);
          } else {
             const factor = this.data.smoothFactor;
             elObj.position.lerp(this.targetPos, factor);
             elObj.quaternion.slerp(this.targetQuat, factor);
             elObj.scale.lerp(this.targetScale, factor);
          }
        },
        startTracking: function () {
          this.data.isTracking = true;
          this.el.setAttribute('visible', 'true');
        },
        stopTracking: function () {
          this.data.isTracking = false;
        }
      });

      // --- COMPONENT 2: PLAYER JUMP LOGIC ---
      AFRAME.registerComponent('player-jump', {
        schema: {
          isJumping: { type: 'boolean', default: false },
          groundY: { type: 'number', default: 0 }
        },

        init: function() {
          this.velocity = 0;
          this.gravity = -0.003; 
          this.jumpPower = 0.08;
          this.isDead = false;
          
          const statusMsg = document.querySelector('#status-msg');
          const jumpBtn = document.querySelector('#jump-btn');

          // Wait for model to load
          this.el.addEventListener('model-loaded', () => {
             console.log("Robot loaded successfully");
             // Update UI
             if(statusMsg) statusMsg.innerText = "Game Ready! Avoid Red Boxes!";
             if(jumpBtn) jumpBtn.style.display = 'block';
             
             this.startRun();
          });

          this.el.addEventListener('model-error', (e) => {
            console.error("Error loading model", e);
            if(statusMsg) statusMsg.innerText = "Error loading 3D Model. Check Internet.";
          });

          // Bind Jump Button
          const btn = document.querySelector('#jump-btn');
          if (btn) {
            const jumpAction = (e) => {
              e.preventDefault(); 
              e.stopPropagation();
              this.triggerJump();
            };
            btn.addEventListener('click', jumpAction);
            btn.addEventListener('touchstart', jumpAction);
          }
        },

        startRun: function() {
          if(this.isDead) return;
          this.el.setAttribute('animation-mixer', {
            clip: 'Running',
            loop: 'repeat',
            crossFadeDuration: 0.3
          });
        },

        triggerJump: function() {
          if (this.data.isJumping || this.isDead) return;
          
          this.data.isJumping = true;
          this.velocity = this.jumpPower;
          
          this.el.setAttribute('animation-mixer', {
            clip: 'Jump',
            loop: 'once',
            clampWhenFinished: true,
            crossFadeDuration: 0.2
          });
        },

        setDead: function() {
          if(this.isDead) return;
          this.isDead = true;
          this.el.setAttribute('animation-mixer', {
            clip: 'Death',
            loop: 'once',
            clampWhenFinished: true
          });
        },

        tick: function(time, timeDelta) {
          if (!this.data.isJumping) return;

          // Physics Loop
          const el = this.el;
          let currentY = el.object3D.position.y;
          
          // Apply gravity
          const deltaFrame = timeDelta / 16; // normalize to 60fps
          currentY += this.velocity * deltaFrame;
          this.velocity += this.gravity * deltaFrame;

          // Floor Hit Check
          if (currentY <= this.data.groundY) {
            currentY = this.data.groundY;
            this.data.isJumping = false;
            this.velocity = 0;
            this.startRun(); // Resume running
          }

          el.object3D.position.y = currentY;
        }
      });

      // --- COMPONENT 3: GAME MANAGER (Spawns Obstacles) ---
      AFRAME.registerComponent('game-manager', {
        init: function() {
          this.timer = 0;
          this.spawnRate = 2500;
          this.obstacles = [];
          this.isPlaying = true;
          this.playerEl = null;
          this.msgEl = document.querySelector('#status-msg');
        },

        tick: function(time, timeDelta) {
          if (!this.isPlaying) return;

          // Find player safely
          if (!this.playerEl) {
            this.playerEl = document.querySelector('#robot-model');
            return;
          }

          this.timer += timeDelta;

          // Spawn
          if (this.timer > this.spawnRate) {
            this.spawnObstacle();
            this.timer = 0;
            if (this.spawnRate > 1000) this.spawnRate -= 50; 
          }

          // Move & Collide
          const playerPos = this.playerEl.object3D.position;
          
          for (let i = 0; i < this.obstacles.length; i++) {
            const obs = this.obstacles[i];
            
            // Move Left
            obs.object3D.position.x -= 0.02 * (timeDelta / 16);

            // Distance Check
            const distX = Math.abs(obs.object3D.position.x - playerPos.x);
            const distY = Math.abs(obs.object3D.position.y - playerPos.y);

            // Hitbox
            if (distX < 0.15 && distY < 0.15) {
              this.gameOver();
            }

            // Cleanup
            if (obs.object3D.position.x < -1.5) {
              if (obs.parentNode) obs.parentNode.removeChild(obs);
              this.obstacles.splice(i, 1);
              i--;
            }
          }
        },

        spawnObstacle: function() {
          const el = document.createElement('a-entity');
          el.setAttribute('geometry', 'primitive: box; width: 0.15; height: 0.15; depth: 0.15');
          el.setAttribute('material', 'color: red');
          el.setAttribute('position', '1.5 0 0'); // Spawn on right
          
          this.el.appendChild(el);
          this.obstacles.push(el);
        },

        gameOver: function() {
          this.isPlaying = false;
          if (this.msgEl) {
            this.msgEl.style.display = 'block';
            this.msgEl.innerHTML = "CRASH! <br> Reload page to play again.";
          }
          if (this.playerEl && this.playerEl.components['player-jump']) {
            this.playerEl.components['player-jump'].setDead();
          }
        }
      });

      // --- SYSTEM: UI CONTROL ---
      document.addEventListener("DOMContentLoaded", function() {
        const exampleTarget = document.querySelector('#example-target');
        const content = document.querySelector('#persistent-content');
        const uiLayer = document.querySelector('#ui-layer');

        if(exampleTarget && content) {
          
          exampleTarget.addEventListener("targetFound", event => {
            console.log("Target Found");
            content.components['follow-target'].startTracking();
            if(uiLayer) uiLayer.style.display = 'flex';
          });

          exampleTarget.addEventListener("targetLost", event => {
            console.log("Target Lost");
            content.components['follow-target'].stopTracking();
          });
        }
      });
    </script>
  </head>
  <body>
    <!-- 2D UI Layer -->
    <div id="ui-layer">
      <div id="status-msg">Scanning... Point at image.</div>
      <div id="jump-btn">JUMP</div>
    </div>

    <!-- 3D Scene -->
    <a-scene 
      mindar-image="imageTargetSrc: targets.mind; uiScanning: no; missTolerance: 5; warmupTolerance: 5;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <img id="card" src="card_MindAR.png" />
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- LIGHTS (Crucial for visibility!) -->
      <a-light type="ambient" intensity="1"></a-light>
      <a-light type="directional" position="1 2 1" intensity="1.5" castShadow="false"></a-light>

      <!-- Target -->
      <a-entity id="example-target" mindar-image-target="targetIndex: 0"></a-entity>
      
      <!-- Content Container -->
      <a-entity 
        id="persistent-content" 
        visible="false" 
        follow-target="target: #example-target"
        game-manager>
        
        <!-- Floor (Invisible collider floor, purely for reference) -->
        <!-- Changed color to white and low opacity, so it's not a black box -->
        <a-plane color="#FFF" rotation="-90 0 0" width="10" height="2" position="0 -0.01 0" opacity="0.1" transparent="true"></a-plane>

        <!-- Player Model -->
        <!-- UPDATED URL to a reliable CDN source -->
        <a-entity 
          id="robot-model"
          gltf-model="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/examples/assets/robot.glb"
          crossorigin="anonymous"
          scale="0.1 0.1 0.1"
          rotation="0 90 0" 
          position="-0.3 0 0" 
          player-jump
        ></a-entity> 
        
      </a-entity>

    </a-scene>
  </body>
</html>
