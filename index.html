<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Interactive AR Story (MindAR)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <!-- 1. Libraries: A-Frame 1.4.2 (Stable for MindAR) and MindAR -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      body { margin: 0; overflow: hidden; font-family: sans-serif; }
      
      /* UI: Main HUD (Story Controls) */
      #story-ui {
        position: absolute;
        bottom: 30px;
        left: 0;
        width: 100%;
        text-align: center;
        z-index: 10;
        display: none; /* Hidden until target found */
        pointer-events: none;
      }

      .story-box {
        background: rgba(255, 255, 255, 0.95);
        padding: 20px;
        border-radius: 15px;
        display: inline-block;
        max-width: 80%;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        pointer-events: auto;
      }

      h2 { margin: 0 0 10px 0; font-size: 20px; color: #333; }
      p { margin: 0 0 15px 0; font-size: 16px; color: #666; }

      button {
        background-color: #4285f4;
        color: white;
        border: none;
        padding: 12px 30px;
        font-size: 16px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        transition: transform 0.1s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      }
      button:active { transform: scale(0.95); }

      /* UI: Tracking Lost / Scanning Overlay */
      #scanning-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 20;
        pointer-events: auto; /* Allow clicking the link */
      }

      .scan-message {
        color: white;
        font-size: 18px;
        font-weight: bold;
        text-align: center;
        border: 2px solid white;
        padding: 20px;
        border-radius: 10px;
        background: rgba(0,0,0,0.5);
        max-width: 80%;
      }

      .target-link {
        display: inline-block;
        margin-top: 15px;
        color: #4dc3ff;
        text-decoration: underline;
        font-size: 16px;
        cursor: pointer;
      }

      #loading-text {
        display: block;
        font-size: 14px;
        margin-bottom: 10px;
        color: #ffff00;
      }
    </style>

    <script>
      /**
       * Component: story-controller
       * Manages the state of the experience.
       * - Handles Target Found/Lost UI switching.
       * - Moves character based on user clicks.
       */
      AFRAME.registerComponent('story-controller', {
        init: function() {
          // UI Elements
          this.scanningOverlay = document.querySelector('#scanning-overlay');
          this.loadingText = document.querySelector('#loading-text');
          this.storyUI = document.querySelector('#story-ui');
          this.storyText = document.querySelector('#story-text');
          this.actionBtn = document.querySelector('#action-btn');
          
          // Scene Elements
          this.marker = document.querySelector('#set-marker');
          this.character = document.querySelector('#character');
          
          // Story State
          this.step = 0;
          
          // 0. Handle Scene Loading
          this.el.sceneEl.addEventListener('arReady', () => {
             if(this.loadingText) this.loadingText.style.display = 'none';
          });
          
          // 1. Handle Tracking Events
          this.marker.addEventListener('targetFound', () => {
            console.log("Target Found");
            this.scanningOverlay.style.display = 'none';
            this.storyUI.style.display = 'block';
          });

          this.marker.addEventListener('targetLost', () => {
            console.log("Target Lost");
            this.scanningOverlay.style.display = 'flex';
            this.storyUI.style.display = 'none';
          });

          // 2. Handle Interaction
          this.actionBtn.addEventListener('click', () => {
            this.advanceStory();
          });
        },

        advanceStory: function() {
          this.step++;
          
          // Simple State Machine
          if (this.step === 1) {
            // Action: Jump to the left
            this.storyText.innerText = "The Explorer inspects the strange ruin...";
            this.actionBtn.innerText = "Check the top";
            
            this.character.removeAttribute('animation');
            this.character.setAttribute('animation', {
              property: 'position',
              to: '-0.3 0 0',
              dur: 1000,
              easing: 'easeInOutQuad'
            });
            
          } else if (this.step === 2) {
            // Action: Jump up top
            this.storyText.innerText = "He found a secret switch!";
            this.actionBtn.innerText = "Finish";
            
            this.character.removeAttribute('animation');
            this.character.setAttribute('animation', {
              property: 'position',
              to: '0 0.25 0', // On top of the cylinder
              dur: 800,
              easing: 'easeOutBack'
            });
            this.character.setAttribute('material', 'color', '#FFD700'); // Turn Gold

          } else {
            // Reset
            this.step = 0;
            this.storyText.innerText = "A wild explorer appears on the set.";
            this.actionBtn.innerText = "Investigate";
            
            this.character.setAttribute('position', '0.4 0 0');
            this.character.setAttribute('material', 'color', '#4CC3D9');
            this.character.setAttribute('rotation', '0 0 0');
          }
        }
      });
    </script>
  </head>
  <body>

    <!-- UI: Scanning / Tracking Lost Overlay -->
    <div id="scanning-overlay">
      <div class="scan-message">
        <span id="loading-text">Loading AR Engine...<br></span>
        ðŸ“¡ Point camera at the Target Image<br>
        
        <!-- LINK TO THE IMAGE -->
        <a href="https://hiukim.github.io/mind-ar-js-doc/assets/images/raccoon-2ef571baece2ee4724d0d19edf3de791.png" target="_blank" class="target-link">
          Click here to open the Raccoon Image
        </a>
      </div>
    </div>

    <!-- UI: Story Controls (Visible only when tracking) -->
    <div id="story-ui">
      <div class="story-box">
        <h2 id="story-title">Chapter 1</h2>
        <p id="story-text">A wild explorer appears on the set.</p>
        <button id="action-btn">Investigate</button>
      </div>
    </div>

    <!-- 
      MindAR Scene 
      imageTargetSrc: Points to the compiled .mind file (required for tracking logic)
    -->
    <a-scene 
      mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/band/band.mind; maxTrack: 1; filterMinCF:0.0001; filterBeta: 0.001; uiLoading: no; uiScanning: no" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">

      <a-assets>
        <!-- Preload any assets here -->
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- LIGHTING: Essential for visibility -->
      <a-light type="ambient" intensity="1"></a-light>
      <a-light type="directional" position="0 0 1" intensity="0.5"></a-light>

      <!-- 
        THE SET ANCHOR (Raccoon Marker)
        All AR content is inside here. 
        (0,0,0) is the center of the image.
      -->
      <a-entity id="set-marker" mindar-image-target="targetIndex: 0" story-controller>
        
        <!-- The "Set" Geometry (Red Platform) -->
        <a-cylinder 
          position="0 0 0" 
          height="0.1" 
          radius="0.4" 
          color="#FF4444" 
          opacity="0.9">
        </a-cylinder>
        
        <!-- The "Character" (Blue Sphere) -->
        <!-- Starting Point: Offset to the right (x=0.4) -->
        <a-sphere 
          id="character"
          position="0.4 0 0" 
          radius="0.1" 
          color="#4CC3D9"
          shadow>
        </a-sphere>

      </a-entity>

    </a-scene>
  </body>
</html>
