<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Multi-Marker Interaction (MindAR)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <!-- 1. Libraries: A-Frame and MindAR -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      body { margin: 0; overflow: hidden; font-family: sans-serif; }
      
      /* UI Overlay */
      #overlay {
        position: absolute;
        top: 20px;
        left: 0;
        width: 100%;
        text-align: center;
        z-index: 10;
        pointer-events: none;
      }
      
      .instruction-box {
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 15px 25px;
        border-radius: 30px;
        display: inline-block;
        max-width: 90%;
      }

      h1 { margin: 0 0 5px 0; font-size: 18px; color: #4dc3ff; }
      p { margin: 0; font-size: 14px; color: #ddd; }
      
      /* Debug Indicators */
      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: red;
        margin-right: 5px;
      }
      .active { background-color: lime; }
    </style>

    <script>
      /**
       * Component: multi-marker-logic
       * Tracks the position of two markers and triggers an event when they are close.
       */
      AFRAME.registerComponent('multi-marker-logic', {
        init: function() {
          // Get references to our entities
          this.baseMarker = document.querySelector('#marker-base');     // Raccoon
          this.charMarker = document.querySelector('#marker-char');     // Bear
          
          this.baseObj = document.querySelector('#base-platform');
          this.charObj = document.querySelector('#character-ball');
          
          this.isLinked = false;
          
          // Debug UI references
          this.racoonDot = document.querySelector('#dot-raccoon');
          this.bearDot = document.querySelector('#dot-bear');
          
          // Add listeners for individual tracking events to update UI
          this.baseMarker.addEventListener('targetFound', () => {
            this.racoonDot.classList.add('active');
          });
          this.baseMarker.addEventListener('targetLost', () => {
            this.racoonDot.classList.remove('active');
          });
          
          this.charMarker.addEventListener('targetFound', () => {
            this.bearDot.classList.add('active');
          });
          this.charMarker.addEventListener('targetLost', () => {
            this.bearDot.classList.remove('active');
          });
        },

        tick: function() {
          if (!this.baseMarker || !this.charMarker) return;

          // Check visibility using object3D properties (reliable in A-Frame loop)
          const isBaseVisible = this.baseMarker.object3D.visible;
          const isCharVisible = this.charMarker.object3D.visible;

          if (isBaseVisible && isCharVisible) {
            
            // 2. Get World Positions
            const basePos = new THREE.Vector3();
            const charPos = new THREE.Vector3();
            
            this.baseMarker.object3D.getWorldPosition(basePos);
            this.charMarker.object3D.getWorldPosition(charPos);

            // 3. Calculate Distance
            const distance = basePos.distanceTo(charPos);

            // 4. Logic: INCREASED THRESHOLD
            // 1.0 unit = width of one image. 
            // Side-by-side images are exactly 1.0 unit apart (center to center).
            // We set threshold to 1.25 to trigger when they are just touching or slightly apart.
            if (distance < 1.25 && !this.isLinked) {
              this.linkObjects();
            } else if (distance >= 1.25 && this.isLinked) {
              this.unlinkObjects();
            }

          } else {
            // Reset if tracking is lost
            if (this.isLinked) this.unlinkObjects();
          }
        },

        linkObjects: function() {
          this.isLinked = true;
          
          // Visual Feedback: Turn Green
          this.charObj.setAttribute('material', 'color', '#00ff00');
          this.baseObj.setAttribute('material', 'color', '#00ff00');

          // Action: Jump Animation
          this.charObj.setAttribute('animation', {
            property: 'position',
            to: '0 1 0', 
            dur: 300,
            easing: 'easeOutQuad',
            loop: 2,
            dir: 'alternate'
          });
          
          document.querySelector('#status-text').textContent = "Linked! Markers Connected.";
        },

        unlinkObjects: function() {
          this.isLinked = false;
          
          // Reset Colors
          this.charObj.setAttribute('material', 'color', '#4CC3D9'); // Blue
          this.baseObj.setAttribute('material', 'color', '#FF4444'); // Red

          // Reset Position
          this.charObj.removeAttribute('animation');
          this.charObj.setAttribute('position', '0 0 0');
          
          document.querySelector('#status-text').textContent = "Move images closer together...";
        }
      });
    </script>
  </head>
  <body>

    <!-- UI Overlay -->
    <div id="overlay">
      <div class="instruction-box">
        <h1>Multi-Marker Demo</h1>
        <p>
          <span id="dot-raccoon" class="status-indicator"></span> Raccoon 
          <span style="margin: 0 10px;">|</span> 
          <span id="dot-bear" class="status-indicator"></span> Bear
        </p>
        <p id="status-text" style="margin-top: 10px; font-weight: bold;">Scan both images...</p>
      </div>
    </div>

    <!-- 
      MindAR Scene 
      imageTargetSrc: The compiled .mind file containing both Raccoon and Bear.
      maxTrack: 2 (Crucial! Allows tracking 2 images at once)
    -->
    <a-scene 
      mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/band/band.mind; maxTrack: 2" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false"
      multi-marker-logic>

      <a-assets>
        <!-- No external models, using primitives for stability -->
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- 
        Marker 1: The "Base" (Index 0 = Raccoon) 
        Shows a Red Platform
      -->
      <a-entity id="marker-base" mindar-image-target="targetIndex: 0">
        <a-cylinder 
          id="base-platform"
          position="0 0 0" 
          height="0.1" 
          radius="0.5" 
          color="#FF4444" 
          opacity="0.8">
        </a-cylinder>
        
        <!-- Text Label -->
        <a-text value="Base" position="0 0.5 0" align="center" color="white" scale="0.5 0.5 0.5"></a-text>
      </a-entity>

      <!-- 
        Marker 2: The "Character" (Index 1 = Bear)
        Shows a Blue Sphere
      -->
      <a-entity id="marker-char" mindar-image-target="targetIndex: 1">
        <a-sphere 
          id="character-ball"
          position="0 0 0" 
          radius="0.3" 
          color="#4CC3D9"
          animation="property: scale; to: 1.1 1.1 1.1; dir: alternate; loop: true; dur: 1000">
        </a-sphere>
        
        <!-- Text Label -->
        <a-text value="Character" position="0 0.5 0" align="center" color="white" scale="0.5 0.5 0.5"></a-text>
      </a-entity>

    </a-scene>
  </body>
</html>
