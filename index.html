<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <script>
      // 1. Register Component with Adaptive Smoothing
      AFRAME.registerComponent('follow-target', {
        schema: {
          target: { type: 'selector' },
          isTracking: { type: 'boolean', default: false },
          smoothFactor: { type: 'number', default: 0.1 }
        },
        
        init: function() {
          this.targetPos = new THREE.Vector3();
          this.targetQuat = new THREE.Quaternion();
          this.targetScale = new THREE.Vector3();
        },

        tick: function (time, timeDelta) {
          if (!this.data.isTracking) return;
          
          const targetEl = this.data.target;
          if (!targetEl || !targetEl.object3D.visible) return;

          const elObj = this.el.object3D;
          const targetObj = targetEl.object3D;

          // 1. READ: Get World Position
          // Because the Target is now a child of the Camera (which rotates via Gyro),
          // getWorldPosition() calculates the correct spot in the 3D 'World'
          targetObj.getWorldPosition(this.targetPos);
          targetObj.getWorldQuaternion(this.targetQuat);
          targetObj.getWorldScale(this.targetScale);

          // 2. SMOOTHING
          const dist = elObj.position.distanceTo(this.targetPos);
          let lerpFactor = 0.1;
          
          if (dist > 1.0) {
             lerpFactor = 1.0; // Snap instantly if far
          } else {
             lerpFactor = dist * 10;
             lerpFactor = Math.min(Math.max(lerpFactor, 0.02), 0.8);
          }

          elObj.position.lerp(this.targetPos, lerpFactor);
          elObj.quaternion.slerp(this.targetQuat, lerpFactor);
          elObj.scale.lerp(this.targetScale, lerpFactor);
        },
        
        startTracking: function () {
          this.data.isTracking = true;
          this.el.setAttribute('visible', 'true');
        },
        
        stopTracking: function () {
          this.data.isTracking = false;
        }
      });

      document.addEventListener("DOMContentLoaded", function() {
        const exampleTarget = document.querySelector('#example-target');
        const content = document.querySelector('#persistent-content');

        if(exampleTarget && content) {
          exampleTarget.addEventListener("targetFound", event => {
            console.log("Target Found");
            content.components['follow-target'].startTracking();
          });
          exampleTarget.addEventListener("targetLost", event => {
            console.log("Target Lost");
            content.components['follow-target'].stopTracking();
          });
        }
      });
    </script>
  </head>
  <body>
    <!-- 
      MindAR Settings:
      - uiScanning: no (Hides the square box)
      - missTolerance: 3 (Keeps content longer if signal is weak)
      - warmupTolerance: 2 (Prevents false positives)
    -->
    <a-scene 
      mindar-image="imageTargetSrc: ./targets.mind; uiScanning: no; missTolerance: 3; warmupTolerance: 2;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <img id="card" src="card_MindAR.png" />
        <a-asset-item id="avatarModel" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/softmind/scene.gltf"></a-asset-item>
      </a-assets>

      <!-- 
        CAMERA UPDATE:
        1. look-controls="enabled: true" -> Enables the Gyroscope/Motion Sensors
        2. mouseEnabled: false / touchEnabled: true -> Prevents user from accidentally dragging the screen and rotating the world manually
      -->
      <a-camera position="0 0 0" look-controls="enabled: false; mouseEnabled: false; touchEnabled: true;">
        
        <!-- 
           HIERARCHY UPDATE:
           The Image Target is now INSIDE the Camera.
           This means the Target moves relative to the Camera.
           Combined with the Camera moving relative to the World (Gyro),
           we get true World coordinates for the content.
        -->
        <a-entity id="example-target" mindar-image-target="targetIndex: 0"></a-entity>
      
      </a-camera>

      <!-- The Content stays OUTSIDE the camera, in the static world -->
      <a-entity 
        id="persistent-content" 
        visible="false" 
        follow-target="target: #example-target">
        <a-gltf-model src="#avatarModel" scale="0.005 0.005 0.005"></a-gltf-model> 
      </a-entity>

    </a-scene>
  </body>
</html>


