<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>iOS Custom UI AR (IMU)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <!-- A-Frame Library -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

    <style>
      body { margin: 0; font-family: sans-serif; overflow: hidden; }

      /* UI Overlay */
      #ui-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        pointer-events: none; /* Let clicks pass through to canvas if needed */
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        align-items: center;
      }

      /* Landing Page for Permissions */
      #permission-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: white;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
      }

      .btn {
        pointer-events: auto;
        background-color: #4285f4;
        color: white;
        font-size: 18px;
        padding: 12px 30px;
        border: none;
        border-radius: 50px;
        font-weight: bold;
        margin-bottom: 40px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      }

      #place-btn {
        display: none; /* Hidden until AR starts */
        background-color: #34a853; /* Green */
      }
      
      #reticle-guide {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255,255,255,0.8);
        border-radius: 50%;
        pointer-events: none;
        display: none; /* Hidden until AR starts */
      }
    </style>

    <script>
      // COMPONENT: Spawner
      AFRAME.registerComponent('spawner', {
        init: function () {
          const placeBtn = document.getElementById('place-btn');
          const camera = document.getElementById('camera');
          
          placeBtn.addEventListener('click', () => {
            // 1. Create new entity
            const newBox = document.createElement('a-entity');
            
            // 2. Set geometry/material
            newBox.setAttribute('geometry', 'primitive: box');
            newBox.setAttribute('material', 'color: #ffcc00');
            newBox.setAttribute('scale', '0.5 0.5 0.5');
            
            // 3. Calculate position: 2 meters in front of camera
            // We get camera rotation, create a vector pointing -Z, and apply rotation
            const position = new THREE.Vector3(0, 0, -2);
            position.applyQuaternion(camera.object3D.quaternion);
            
            // 4. Set Position and Rotation
            newBox.object3D.position.copy(position);
            newBox.object3D.rotation.y = camera.object3D.rotation.y;
            
            // 5. Add Animation
            newBox.setAttribute('animation', {
              property: 'scale',
              from: '0 0 0',
              to: '0.5 0.5 0.5',
              dur: 500,
              easing: 'easeOutElastic'
            });

            // 6. Add to scene
            this.el.sceneEl.appendChild(newBox);
          });
        }
      });

      // FUNCTION: iOS Permission Request
      async function requestMotionPermission() {
        const permissionOverlay = document.getElementById('permission-overlay');
        const placeBtn = document.getElementById('place-btn');
        const reticle = document.getElementById('reticle-guide');

        // iOS 13+ Requirement
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
          try {
            const permissionState = await DeviceMotionEvent.requestPermission();
            if (permissionState === 'granted') {
              startAR();
            } else {
              alert('Permission denied. AR will not work.');
            }
          } catch (error) {
            console.error(error);
            alert('Error requesting permission: ' + error);
          }
        } else {
          // Non-iOS 13+ devices (Android or older iOS)
          startAR();
        }

        function startAR() {
          permissionOverlay.style.display = 'none';
          placeBtn.style.display = 'block';
          reticle.style.display = 'block';
        }
      }
    </script>
  </head>

  <body>

    <!-- 1. Permission Landing Page -->
    <div id="permission-overlay">
      <h1>Simple WebAR</h1>
      <p style="padding: 0 20px; color: #666;">
        This experience uses your phone's sensors.<br>
        Objects will float at eye-level.
      </p>
      <button class="btn" onclick="requestMotionPermission()">Enable Sensors & Start</button>
    </div>

    <!-- 2. Main UI Layer -->
    <div id="ui-layer">
      <!-- Custom Place Button -->
      <button id="place-btn" class="btn">ðŸ‘‡ Place Cube Here</button>
    </div>

    <!-- Center Screen Guide -->
    <div id="reticle-guide"></div>

    <!-- 3. A-Frame Scene -->
    <!-- 
      vr-mode-ui="enabled: false" hides the VR goggles button.
      background="color: transparent" allows camera feed (handled by CSS usually, but here A-Frame creates a canvas)
      NOTE: A-Frame stock does not do camera passthrough on mobile standard browser easily without WebXR.
      Workaround: We set sky to transparent and assume 'magic-window' mode.
    -->
    <a-scene 
      vr-mode-ui="enabled: false"
      spawner>

      <!-- Camera -->
      <!-- look-controls="magicWindowTrackingEnabled: true" enables IMU tracking -->
      <a-camera id="camera" position="0 1.6 0" look-controls="magicWindowTrackingEnabled: true"></a-camera>
      
      <!-- Lighting -->
      <a-light type="directional" position="-1 2 4"></a-light>
      <a-light type="ambient" intensity="0.6"></a-light>

      <!-- 
        CAMERA FEED NOTE: 
        Standard A-Frame cannot access the camera feed on iOS Safari without '8th Wall' or 'AR.js'.
        Since this is a 'Self-Hosted' request without libraries, the background will be 
        WHITE or BLACK by default.
        
        To get the camera feed here without 8th Wall, you would normally need <video> element manipulation,
        which is essentially what AR.js does.
      -->

      <!-- For this demo, we use a grid background to show tracking works -->
      <a-sky color="#ECECEC"></a-sky>

    </a-scene>
  </body>
</html>
