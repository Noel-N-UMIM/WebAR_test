<!-- Start of the HTML document  -->
<html>
  <head>
    <!-- Sets the viewport for mobile devices to ensure correct scaling  -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <!-- Import A-Frame library (framework for building 3D/AR on the web)  -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    
    <!-- Import MindAR library (engine for image tracking)  -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      /* Basic reset for body margins  */
      body { margin: 0; }
      
      /* Container for the "Start AR" button overlay */
      #start-button-container {
        position: absolute; /* Floating above content  */
        top: 0; left: 0; right: 0; bottom: 0; /* Full screen  */
        z-index: 11; /* Ensures it sits on top of the camera  */
        display: flex; /* Use flexbox for centering  */
        justify-content: center; /* Center horizontally  */
        align-items: center; /* Center vertically  */
        background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent black background  */
      }
      
      /* Styling for the action button  */
      .action-button {
        padding: 12px 24px;
        font-size: 1.2rem;
        font-weight: bold;
        color: white;
        background-color: #007aff; /* iOS Blue  */
        border: none;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); /* Subtle shadow */
      }
    </style>

    <script>
      // --- CUSTOM COMPONENT: The "Magnet" Logic ---
      
      // Registers a new A-Frame component named 'follow-target' 
      AFRAME.registerComponent('follow-target', {
        // Defines the properties (inputs) this component accepts 
        schema: {
          target: {type: 'selector'}, // Reference to the target element to follow 
          isTracking: {type: 'boolean', default: false} // Switch to enable/disable tracking 
        },
        
        // 'tick' runs every single frame (approx 60 times per second) 
        tick: function () {
          
          // If tracking is OFF or no target is assigned, stop here 
          if (!this.data.isTracking || !this.data.target) {
            return;
          }
          
          // If the target itself is hidden (lost by MindAR), stop tracking logic 
          if (!this.data.target.object3D.visible) {
            this.data.isTracking = false; 
            return;
          }

          // Get the underlying 3D objects (Three.js objects) / 
          const targetObj = this.data.target.object3D;
          const elObj = this.el.object3D;
          
          // COPY position, rotation, and scale from Target -> PASTE to Content
      
          targetObj.getWorldPosition(elObj.position);
          targetObj.getWorldQuaternion(elObj.quaternion);
          targetObj.getWorldScale(elObj.scale);
        },
        
        // Helper function to turn the "magnet" ON 
        startTracking: function() {
          this.data.isTracking = true;
        },
        // Helper function to turn the "magnet" OFF 
        stopTracking: function() {
          this.data.isTracking = false;
        }
      });

      // Main setup when the page loads 
      document.addEventListener("DOMContentLoaded", function() {
        // Select main DOM elements 
        const sceneEl = document.querySelector('a-scene');
        const startButtonContainer = document.querySelector("#start-button-container");
        const startButton = document.querySelector("#start-button");
      
        const exampleTarget = document.querySelector('#example-target'); // The MindAR anchor 
        const persistentContent = document.querySelector("#persistent-content"); // The decoupled content container 
        const videoAsset = document.querySelector("#videoAsset"); // The raw video element 
        let arSystem;

        // Access MindAR system once the scene is loaded 
        sceneEl.addEventListener('loaded', function () {
          arSystem = sceneEl.systems["mindar-image-system"];
        });

        // Setup Start Button (Crucial for browser autoplay policies)
        
        startButton.addEventListener('click', () => {
          // "Prime" the video: play and immediately pause to get permission 
          if (videoAsset) {
            videoAsset.play();
            videoAsset.pause();
          }
          arSystem.start(); // Start the AR camera 
          startButtonContainer.style.display = 'none'; // Hide the button overlay 
        });
        
        // EVENT: When the Image Target is detected 
        exampleTarget.addEventListener("targetFound", event => {
          console.log("target found");
          
          // Make the 3D content visible 
          persistentContent.setAttribute('visible', 'true');
          
          // Start playing the video 
          if (videoAsset) videoAsset.play(); 
          
          // Enable the "magnet": Content starts following the target
          
          persistentContent.components['follow-target'].startTracking();
        });

        // EVENT: When the Image Target is lost 
        exampleTarget.addEventListener("targetLost", event => {
          console.log("target lost");

          // Disable the "magnet". The content stops updating its position.
         
          // IMPORTANT: We DO NOT hide the content here. It stays "frozen" in place.
         
          persistentContent.components['follow-target'].stopTracking();
        });
      });
    </script>
  </head>
  
  <body>
    <!-- UI Overlay for Start Button  -->
    <div id="start-button-container" class="button-container">
      <button id="start-button" class="action-button">Iniciar AR</button>
    </div>
    
    <!-- AR Scene Setup / -->
    <!-- 'mindar-image': Main config (target file location, autoStart off)  -->
    <!-- 'color-space' & 'renderer': Improving visual quality  -->
    <a-scene 
      mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; maxTrack: 2; filterMinCF:1; filterBeta:10000; warmupTolerance:0.5; missTolerance:0.5;"
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <!-- Asset Management System  -->
      <a-assets>
        <!-- Video asset setup  -->
        <video id="videoAsset" 
               preload="auto" 
               loop="true" 
               muted="true"
               crossOrigin="anonymous" 
               src="./videoAR.mp4">
        </video>
        
        <!-- 3D Model asset setup (Wolf.glb)  -->
        <a-asset-item id="tigerModel" src="./Wolf.glb" preload="auto"></a-asset-item>
      </a-assets>

      <!-- The Camera  -->
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- 
           THE TARGET ANCHOR / EL ANCLA DEL TARGET
           This entity is controlled by MindAR. It becomes visible/invisible automatically.
          
           Notice it is EMPTY. It has no children inside.
           
      -->
      <a-entity id="example-target" mindar-image-target="targetIndex: 0"></a-entity>
      
      <!-- 
           THE DECOUPLED CONTENT 
           This is a SIBLING of the target, not a child.
           
           It uses our custom 'follow-target' component to sync manually.
          
      -->
      <a-entity 
        id="persistent-content" 
        visible="false" 
        follow-target="target: #example-target; isTracking: false"
        >
        
        <!-- The AR Video Plane / El Plano de Video AR -->
        <a-video 
          id="ar-video"
          src="#videoAsset" 
          width="2" 
          height="1" 
          position="-1 0 0" 
          rotation="0 0 0"
          muted="true">
        </a-video>
        
        <!-- The 3D Model / El Modelo 3D -->
        <a-gltf-model
          id="ar-model"
          src="#tigerModel"
          scale="0.3 0.3 0.3"
          position="0.5 -0.5 0"
          rotation="0 -90 0">
        </a-gltf-model>

      </a-entity>
      
    </a-scene>
  </body>
</html>