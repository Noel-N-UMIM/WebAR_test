<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MindAR Image-to-World Handoff</title>
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <script>
      /**
       * COMPONENT: image-handoff-system
       * * Emulates 8th Wall's "Image-to-SLAM" handoff for MindAR.
       * When the image target is found, the content snaps to the image.
       * When the image target is lost, the content remains visible and stays 
       * at its last known world position (anchored to the scene).
       * * Note: Since MindAR is image-only (no native SLAM), 'World Tracking' 
       * here relies on the device's gyro (3DOF) after the target is lost.
       */
      AFRAME.registerComponent('image-handoff-system', {
        schema: {
          target: { type: 'selector' } // The content to hand off
        },

        init: function () {
          this.isFound = false;
          this.contentEl = this.data.target;
          
          // Bind methods
          this.onTargetFound = this.onTargetFound.bind(this);
          this.onTargetLost = this.onTargetLost.bind(this);
          
          // Listen to MindAR events on this entity (the image target)
          this.el.addEventListener('mindar-image-found', this.onTargetFound);
          this.el.addEventListener('mindar-image-lost', this.onTargetLost);
        },

        onTargetFound: function () {
          console.log("Target Found: Snapping content to target.");
          this.isFound = true;

          // Reparent content back to the image target (this.el)
          // This allows MindAR to control the position again
          if (this.contentEl.parentEl !== this.el) {
            this.contentEl.object3D.position.set(0, 0, 0);
            this.contentEl.object3D.rotation.set(0, 0, 0);
            this.contentEl.object3D.scale.set(1, 1, 1); // Reset scale if needed
            this.el.object3D.add(this.contentEl.object3D);
          }

          // Ensure visible
          this.contentEl.setAttribute('visible', true);
        },

        onTargetLost: function () {
          console.log("Target Lost: Handing off to World.");
          
          // 1. Get the current World Position and Rotation of the content
          const worldPos = new THREE.Vector3();
          const worldQuat = new THREE.Quaternion();
          const worldScale = new THREE.Vector3();
          
          this.contentEl.object3D.getWorldPosition(worldPos);
          this.contentEl.object3D.getWorldQuaternion(worldQuat);
          this.contentEl.object3D.getWorldScale(worldScale);

          // 2. Reparent to the Scene (World)
          // This detaches it from the tracking target so it stops jumping around
          // or disappearing when the target is gone.
          const scene = this.el.sceneEl;
          scene.object3D.add(this.contentEl.object3D);

          // 3. Apply the saved World Transforms to maintain visual continuity
          this.contentEl.object3D.position.copy(worldPos);
          this.contentEl.object3D.quaternion.copy(worldQuat);
          this.contentEl.object3D.scale.copy(worldScale);

          // 4. Force visibility (MindAR tries to hide children of targets on loss)
          this.contentEl.setAttribute('visible', true);
        }
      });
    </script>

    <style>
      /* Simple UI Overlay */
      #scanning-overlay {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        pointer-events: none;
        z-index: 999;
      }
      .inner {
        background: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 20px;
        border-radius: 10px;
        font-family: sans-serif;
      }
    </style>
  </head>
  <body>
    <div id="scanning-overlay">
      <div class="inner">Scan the Target Image</div>
    </div>

    <a-scene 
      mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind; uiLoading: no; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.001;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

   <a-assets>
	<img id="card" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png" />
	<a-asset-item id="avatarModel" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/softmind/scene.gltf"></a-asset-item>
      </a-assets>

      <a-entity id="my-ar-object" mixin="cube-model" position="0 0 0" scale="0.5 0.5 0.5" visible="false"></a-entity>

      <a-entity 
        mindar-image-target="targetIndex: 0"
        image-handoff-system="target: #my-ar-object">
      </a-entity>

    </a-scene>
  </body>
</html>
