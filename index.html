<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>WebXR Self-Hosted SLAM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <!-- UI Styles -->
    <style>
      body { margin: 0; font-family: sans-serif; }
      #overlay {
        position: absolute;
        bottom: 30px;
        left: 0;
        width: 100%;
        text-align: center;
        z-index: 10;
        pointer-events: none;
        display: none; /* Hidden until AR starts */
      }
      
      #ar-instructions {
        font-size: 16px;
        color: white;
        text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        margin-bottom: 20px;
      }

      /* WebXR DOM Overlay requires the element to be visible */
      body.a-fullscreen #overlay {
        display: block;
      }
    </style>

    <!-- A-Frame 1.4.0+ is required for WebXR AR Module -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>

    <script>
      /**
       * Component: ar-shadows
       * Creates a shadow-only plane that updates nicely in AR
       */
      AFRAME.registerComponent('ar-shadows', {
        schema: { opacity: {default: 0.3} },
        init: function () {
          this.el.sceneEl.addEventListener('enter-vr', (ev) => {
            this.wasVisible = this.el.getAttribute('visible');
            if (this.el.sceneEl.is('ar-mode')) {
              this.el.setAttribute('visible', true);
            }
          });
          this.el.sceneEl.addEventListener('exit-vr', (ev) => {
            if (this.wasVisible) this.el.setAttribute('visible', this.wasVisible);
          });
        }
      });

      /**
       * Component: reticle-listener
       * Handles the logic for the "Hit Test" reticle.
       * When the user taps the screen while the reticle is visible, 
       * we spawn/move the object to that location.
       */
      AFRAME.registerComponent('reticle-listener', {
        init: function () {
          const reticle = this.el;
          // We query this inside the event or ensure element order prevents null
          const objectToPlace = document.getElementById('slam-object');
          const scene = this.el.sceneEl;

          // Listen for taps (select event in WebXR)
          scene.addEventListener('click', (e) => {
            if (!objectToPlace) return;

            // Only place if the reticle is currently visible (tracking a surface)
            if (reticle.getAttribute('visible')) {
              
              // Move object to reticle position
              objectToPlace.setAttribute('position', reticle.getAttribute('position'));
              objectToPlace.setAttribute('rotation', reticle.getAttribute('rotation'));
              objectToPlace.setAttribute('visible', 'true');

              // Play a small spawn animation
              objectToPlace.removeAttribute('animation');
              objectToPlace.setAttribute('scale', '0 0 0');
              objectToPlace.setAttribute('animation', {
                property: 'scale',
                to: '0.5 0.5 0.5',
                dur: 500,
                easing: 'easeOutElastic'
              });
            }
          });
        }
      });
    </script>
  </head>

  <body>
    <!-- DOM Overlay for UI -->
    <div id="overlay">
      <div id="ar-instructions">Find a flat surface and tap to place the object</div>
    </div>

    <!-- 
      WebXR Scene Config
      webxr="optionalFeatures: hit-test, dom-overlay; overlayElement: #overlay"
      This enables the native AR capabilities of the browser.
    -->
    <a-scene 
      webxr="optionalFeatures: hit-test, dom-overlay; overlayElement: #overlay"
      renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true"
      cursor="rayOrigin: mouse"
      raycaster="objects: .collidable">

      <a-assets>
        <img id="boxTexture" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/cubes.jpg">
        <!-- Reticle Graphic -->
        <img id="reticleImg" src="https://cdn.jsdelivr.net/gh/google-ar/ar-samples-web-manager@master/static/reticle.png">
      </a-assets>

      <a-light type="directional" intensity="1" position="-1 2 4"></a-light>
      <a-light type="ambient" intensity="0.5"></a-light>

      <!-- 
        1. The SLAM Object (MOVED UP)
        We place this BEFORE the reticle so that when ar-hit-test loads, 
        document.querySelector('#slam-object') finds this element successfully.
      -->
      <a-entity id="slam-object" visible="false">
        <a-box 
          position="0 0.25 0" 
          scale="0.5 0.5 0.5"
          material="src: #boxTexture; color: #7B68EE"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 5000; easing: linear">
        </a-box>
        
        <!-- Shadow Plane -->
        <a-plane 
          rotation="-90 0 0" 
          width="1.5" height="1.5" 
          material="shader: shadow; opacity: 0.4"
          ar-shadows>
        </a-plane>
      </a-entity>

      <!-- 
        2. AR Hit Test Reticle 
        This entity uses 'ar-hit-test' which references the #slam-object above.
      -->
      <a-entity 
        ar-hit-test="target: #slam-object; type: map"
        reticle-listener>
        
        <!-- Visual Reticle -->
        <a-plane 
          rotation="-90 0 0" 
          width="0.2" height="0.2" 
          src="#reticleImg" 
          transparent="true">
        </a-plane>
      </a-entity>

      <!-- Camera -->
      <!-- Only the position matters here, rotation/translation is controlled by WebXR -->
      <a-camera position="0 1.6 0"></a-camera>

    </a-scene>
  </body>
</html>
